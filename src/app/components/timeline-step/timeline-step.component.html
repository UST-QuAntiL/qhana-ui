<qhana-experiment-nav active="timeline"></qhana-experiment-nav>
<div class="big-content" *ngIf="timelineStep != null">
    <h1 class="t-page-headline">Timeline Step</h1>
    <mat-card class="experiment-card card">
        <mat-card-title class="t-headline flex-title">
            Step {{timelineStep.sequence}} ({{timelineStep.processorName}}@{{timelineStep.processorVersion}})
            <qhana-step-status [step]="timelineStep" [noText]="true"></qhana-step-status>
            <div class="spacer"></div>
            <span class="t-subheading clickable" (click)="restartWatching()" *ngIf="timelineStep?.end == null">
                {{watching}}
            </span>
            <button mat-button color="primary" (click)="restartWatching()"
                *ngIf="timelineStep?.end == null && watching === 'error' || watching === 'paused'">
                restart
            </button>
        </mat-card-title>
        <mat-card-content>
            <dl class="step-details">
                <div>
                    <dt>Status</dt>
                    <dd>
                        <qhana-step-status [step]="timelineStep"></qhana-step-status>
                    </dd>
                </div>
                <div *ngIf="stepProgress != null">
                    <dt>Progress</dt>
                    <dd>
                        <div class="step-progress">
                            <mat-progress-bar class="progress-meter" mode="determinate" color="primary"
                                [value]="((stepProgress.value-stepProgress.start) / (stepProgress.target-stepProgress.start)) * 100">
                            </mat-progress-bar>
                            <span [hidden]="stepProgress.unit == null">
                                {{stepProgress.value}}/{{stepProgress.target}} {{stepProgress.unit}}
                            </span>
                        </div>
                    </dd>
                </div>
                <div *ngIf="timelineStep.status !== 'PENDING'">
                    <dt>Result Quality</dt>
                    <dd>
                        <mat-form-field appearance="fill">
                            <mat-label>Result Quality</mat-label>
                            <mat-select [value]="resultQuality" (valueChange)="saveResultQuality($event)">
                                <mat-option [value]="'UNKNOWN'">unknown</mat-option>
                                <mat-option [value]="'NEUTRAL'">neutral</mat-option>
                                <mat-option [value]="'GOOD'">good</mat-option>
                                <mat-option [value]="'BAD'">bad</mat-option>
                                <mat-option [value]="'ERROR'">error</mat-option>
                                <mat-option [value]="'UNUSABLE'">unusable</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </dd>
                </div>
                <div *ngIf="timelineStep.status === 'PENDING'">
                    <dt>Started at</dt>
                    <dd>{{timelineStep.start | date:'HH:mm:ss (dd MMMM YYYY)'}}</dd>
                </div>
                <div *ngIf="timelineStep.status !== 'PENDING'">
                    <dt>Timing</dt>
                    <dd>
                        {{timelineStep.start | date:'HH:mm:ss (dd MMMM YYYY)'}}
                        â€“ {{timelineStep.end | date:'HH:mm:ss (dd MMMM YYYY)'}}
                    </dd>
                </div>
                <div>
                    <dt>Processor</dt>
                    <dd>{{timelineStep.processorName}} (version {{timelineStep.processorVersion}})</dd>
                </div>
                <div>
                    <dt>Processor Location</dt>
                    <dd>{{timelineStep.processorLocation}}</dd>
                </div>
            </dl>
            <details class="collapsible-item" [open]="timelineStep.status === 'PENDING'">
                <summary class="summary-item">Result Log</summary>
                {{timelineStep.resultLog}}
            </details>
            <details class="collapsible-item">
                <summary class="summary-item">Parameters</summary>
                <qhana-data-preview [data]="timelineStep"></qhana-data-preview>
            </details>
        </mat-card-content>
    </mat-card>
    <div class="notes-title" *ngIf="timelineStep.status !== 'PENDING'">
        <h2>Notes</h2>
        <div class="notes-status" *ngIf="notesStatus === 'changed'">
            <span>pending changes</span>
            <mat-spinner mode="indeterminate" diameter="30" color="primary"></mat-spinner>
        </div>
        <div class="notes-status" *ngIf="notesStatus === 'saved'">
            <span>saved</span>
            <mat-icon aria-hidden="true">checkmark</mat-icon>
        </div>
    </div>
    <mat-card class="card" *ngIf="timelineStep.status !== 'PENDING'">
        <mat-card-content>
            <qhana-markdown [markdown]="stepNotes" (markdownChanges)="triggerNoteAutosave($event)" [editable]="true"
                [hidden]="timelineStep == null || timelineStep.status === 'PENDING'" *ngIf="stepNotes != null">
            </qhana-markdown>
            <mat-spinner class="notes-content-spinner" mode="indeterminate" strokeWidth="5" color="primary"
                *ngIf="stepNotes == null">
            </mat-spinner>
        </mat-card-content>
    </mat-card>
    <ng-container *ngIf="timelineStep.outputData != null && timelineStep.outputData.length > 0">
        <h2>Output</h2>
        <qhana-preview-list [dataList]="timelineStep.outputData ?? []"></qhana-preview-list>
    </ng-container>
    <ng-container *ngIf="timelineStep.inputData != null && timelineStep.inputData.length > 0">
        <h2>Input</h2>
        <qhana-preview-list [dataList]="timelineStep.inputData ?? []"></qhana-preview-list>
    </ng-container>
    <qhana-timeline-substeps class="timeline-substeps" [substeps]="substeps" [experimentId]="experimentId"
        [parentFinished]="timelineStep.status !== 'PENDING'" *ngIf="substeps != null && substeps.length > 0">
    </qhana-timeline-substeps>
    <div class="scroll-spacer"></div>
</div>
